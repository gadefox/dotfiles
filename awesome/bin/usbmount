#!/bin/rc
. /usr/local/libexec/rc/notify
. /usr/local/libexec/rc/util
notify_icon = usb
notify_title = Device:

fn info {
  lsblk -nro PATH,LABEL,MOUNTPOINT | grep $1
}

fn check {
  ~ $1 Error* || return
  msg = `(lastpart $1 :)
  notify_error 'Error: '$^msg'.' $2
}

if (~ $* () || ~ $1 1) {
  usb = ``($nl) { lsblk -Jo TRAN,NAME,LABEL,SIZE | \
    jq -r '.blockdevices[] | select(.tran == "usb") | .children[]? | "\(.name): \(.label // "no-label") (\(.size))"' }

  ~ $usb () && notify_error 'No USB drive found.'
  ~ $#usb 1 || usb = ``($nl) { echo $usb | dmenu -p 'Select USB' }

  usb = `(npart $usb : 1)
  ~ $1 1 && { echo $usb; exit 0 }
  * = (2 $usb)
}

if (~ $1 2) {
  usb = `(info $2)
  !~ $usb(3) () && msg = 'already ' || {
    ret = ``($nl) { udisksctl mount -b $usb(1) >[2=1] }
    check $ret $usb(2)
    usb = ($usb(1 2) `(lastpart $ret ' '))
  }

  opt = `(notify_show '`'$usb(1)^'` is '$msg'mounted at '$usb(3) $usb(2) f=Folder)
  notify_xdg $usb(3) $opt

  echo $usb
  exit 0
}

if (~ $1 3) {
  usb = `(info $2)
  check ``($nl) { udisksctl unmount -b $usb(1) >[2=1] } $usb(2)
  notify_show '`'$usb(1)^'` was successfully unmounted.' $usb(2)
  exit 0
}

exit 1
