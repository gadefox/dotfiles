#!/bin/rc
. /usr/local/libexec/rc/notify
notify_icon = camera
notify_title = Virtual camera:

fn state { cat /sys/devices/virtual/video4linux/video10/state }

fn isflip {
  val = `state
  if (!~ $val capture) {
    notify_show 'The image is not turned upside down. (ffmpeg)'
    echo $val
  }
}

if (~ $1 -p || ~ $1 1) {
  ~ `state capture && exec ffplay /dev/video10
  exec v4l2-flip ffplay /dev/video0
}

if (~ $1 -f || ~ $1 2) {
  if (!~ `state capture) {
    notify_show 'Turning the image upside down. (ffmpeg)'
    exec ffmpeg -i /dev/video0 -vf vflip -f v4l2 /dev/video10
  }

  notify_show 'The image is already turned upside down. (ffmpeg)'
  exit 0
}

if (~ $1 -s || ~ $1 3) {
  if (~ `isflip ()) {
    pkill -f 'ffmpeg -i /dev/video0 -vf vflip -f v4l2 /dev/video10'
    notify_show 'Turning the image upside down has stopped. (ffmpeg)'
  }
  exit 0
}

if (~ $1 -i || ~ $1 4) {
  ~ `isflip () && notify_show 'The image is turned upside down. (ffmpeg)'
  exit 0
}

exit 1
